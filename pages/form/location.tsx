import type { NextPage } from "next";
import Head from "next/head";
import { useState } from "react";
import FormNextButton from "../../components/form/next-button";
import ProgressBar from "../../components/form/progress-bar";
import { cities } from "../../constants/cities";
import { useFormState } from "../../context/form-context";
import { fakeOrder } from "../../models/order";
import styles from "../../styles/Form.module.css";
type Product = {
  images: string[];
  locations: string[];
  material: string;
  name: string;
  numOrders: number;
  numSold: number;
  price: {
    quantity: number;
    price: number;
  }[];
  size: string;
};

const LocationPage: NextPage = () => {
  const { addLocation, addSummary, locations, removeLocation } = useFormState();
  const [query, setQuery] = useState<string>("");
  const [drawerOpen, toggleDrawer] = useState<boolean>();
  console.log(locations);
  console.log(locations.length);

  function handleClick(city: string) {
    if (locations.includes(city)) {
      removeLocation(city);
    } else {
      addLocation(city);
    }
    // setNewCity((prev) => (prev == city ? "" : city));
    setQuery("");
    toggleDrawer((prev) => !prev);
  }

  const options = cities
    .filter((city) => city.toLowerCase().startsWith(query.toLowerCase()))
    .map((city) => (
      <div
        key={city}
        className="flex justify-between p-2 hover:bg-gray-200"
        onClick={() => handleClick(city)}
      >
        <div className="text-xl">{city}</div>
        {locations.includes(city) ? <div className="text-xl">âœ”</div> : null}
      </div>
    ));

  function createFakeOrder() {
    fetch("/api/orders/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ json: JSON.stringify(fakeOrder) }),
    })
      .then((res) => res.json())
      .then((data) => console.log(data));
  }
  return (
    <div className={styles.container}>
      <Head>
        <title>Find your perfect setup</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <ProgressBar pageName={"location"} />
      <main className={styles.main}>
        <h1 className=" text-6xl font-semibold">
          What cities do you operate in
        </h1>
        <div className=" text-sm italic self-start mb-8 ml-2">
          Select all that apply
        </div>
        <input
          className=" text-xl p-4 border-2 border-gray-300 rounded-md w-3/5"
          type="text"
          value={
            locations.length == 0 ? query : locations.join(", ") + ", " + query
          }
          onFocus={() => toggleDrawer(true)}
          onChange={(e) =>
            setQuery(
              locations.length == 0
                ? e.target.value
                : e.target.value.split(", ").slice(-1)[0]
            )
          }
          placeholder="Enter city..."
          required
        />
        {drawerOpen && (
          <div className=" bg-gray-50 w-3/5 border-2 border-t-0 rounded-b-md max-h-64 overflow-auto">
            {options}
          </div>
        )}
        <button
          className=" bg-blue-600 px-4 py-2 text-lg text-white"
          onClick={createFakeOrder}
        >
          Order
        </button>
      </main>
      <FormNextButton
        pageName={"location"}
        disabled={locations.length < 1}
        onClick={() => addSummary()}
      />
    </div>
  );
};

export default LocationPage;
